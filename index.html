<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Paisa â€” Personal Finance</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getAuth, GoogleAuthProvider, signInWithPopup,
    signOut, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getFirestore, collection, doc,
    onSnapshot, addDoc, setDoc, deleteDoc, getDocs,
    serverTimestamp, query, orderBy
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  // â•‘  STEP 1 â€” YOUR FIREBASE CONFIG                       â•‘
  // â•‘  Firebase Console â†’ Project Settings â†’ Your Apps    â•‘
  // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
  apiKey: "AIzaSyDXoEXois6MZOQ9dJR211j1oQFbtjso2ho",
  authDomain: "paisa-44a61.firebaseapp.com",
  projectId: "paisa-44a61",
  storageBucket: "paisa-44a61.firebasestorage.app",
  messagingSenderId: "305122900130",
  appId: "1:305122900130:web:9cdf98ada9315414963ffb"
};

  // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  // â•‘  STEP 2 â€” YOUR GMAIL (only this account can log in) â•‘
  // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const ALLOWED_EMAIL = "your.email@gmail.com";

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  window._fb = {
    auth, db, ALLOWED_EMAIL,
    GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged,
    collection, doc, onSnapshot, addDoc, setDoc, deleteDoc,
    getDocs, serverTimestamp, query, orderBy
  };
  window.dispatchEvent(new Event('firebase-ready'));
</script>

<style>
:root {
  --bg:#0a0a0f; --bg2:#12121a; --bg3:#1a1a26; --bg4:#22223a;
  --gold:#f5a623; --gold2:#ffcc6b; --gold-dim:rgba(245,166,35,0.15);
  --green:#2ecc71; --green-dim:rgba(46,204,113,0.12);
  --red:#e74c3c; --blue:#3498db;
  --text:#f0f0f8; --text2:#9090b0; --text3:#5a5a7a;
  --border:rgba(255,255,255,0.07); --radius:16px; --radius-sm:10px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--text);font-family:'Sora',sans-serif;min-height:100vh;max-width:480px;margin:0 auto;overflow-x:hidden}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:4px}

/* LOADING */
#loading-screen{position:fixed;inset:0;z-index:2000;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px}
#loading-screen.gone{display:none}
.spinner{width:44px;height:44px;border:3px solid var(--bg4);border-top-color:var(--gold);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:13px;color:var(--text2);font-family:'DM Mono',monospace}

/* LOGIN */
#login-screen{position:fixed;inset:0;z-index:1500;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 28px;animation:fadeUp .5s ease}
#login-screen.gone{display:none}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.login-glow{position:absolute;top:-60px;left:50%;transform:translateX(-50%);width:320px;height:320px;background:radial-gradient(circle,rgba(245,166,35,.07),transparent 70%);pointer-events:none}
.login-logo{font-size:64px;margin-bottom:12px;filter:drop-shadow(0 4px 20px rgba(245,166,35,.3))}
.login-appname{font-size:42px;font-weight:800;letter-spacing:-2px;margin-bottom:6px}
.login-appname span{color:var(--gold)}
.login-tagline{font-size:13px;color:var(--text3);text-align:center;line-height:1.7;margin-bottom:40px;max-width:260px}
.login-card{width:100%;max-width:340px;background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:28px 24px;margin-bottom:16px}
.login-card-title{font-size:15px;font-weight:600;margin-bottom:6px}
.login-card-sub{font-size:12px;color:var(--text2);margin-bottom:24px;line-height:1.5}
.google-btn{display:flex;align-items:center;justify-content:center;gap:12px;width:100%;background:white;color:#1f1f1f;border:none;border-radius:12px;padding:14px 20px;font-family:'Sora',sans-serif;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;box-shadow:0 4px 20px rgba(0,0,0,.3)}
.google-btn:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(0,0,0,.4)}
.google-btn:active{transform:scale(.98)}
.google-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
.google-svg{width:20px;height:20px;flex-shrink:0}
.login-lock{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text3);margin-top:14px;justify-content:center}

/* ACCESS DENIED */
#denied-screen{position:fixed;inset:0;z-index:1600;background:var(--bg);display:none;flex-direction:column;align-items:center;justify-content:center;padding:40px 28px;text-align:center}
#denied-screen.show{display:flex;animation:fadeUp .4s ease}
.denied-icon{font-size:72px;margin-bottom:20px}
.denied-title{font-size:26px;font-weight:800;color:var(--red);margin-bottom:8px}
.denied-sub{font-size:13px;color:var(--text2);line-height:1.7;margin-bottom:24px;max-width:280px}
.denied-badge{background:var(--bg2);border:1px solid rgba(231,76,60,.3);border-radius:10px;padding:10px 18px;font-size:13px;font-family:'DM Mono',monospace;color:var(--red);margin-bottom:28px;word-break:break-all;max-width:320px}
.denied-btn{background:var(--bg3);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:12px 28px;font-family:'Sora',sans-serif;font-size:14px;font-weight:600;cursor:pointer;transition:background .2s}
.denied-btn:active{background:var(--bg4)}

/* MAIN */
#main-app{display:none}
#main-app.on{display:block}

/* SCREENS */
.screen{display:none;min-height:calc(100vh - 70px);padding:0 0 90px;animation:fadeIn .3s ease}
.screen.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* TOPBAR */
.topbar{position:sticky;top:0;z-index:100;background:linear-gradient(180deg,var(--bg) 80%,transparent);padding:16px 20px 8px;display:flex;align-items:center;justify-content:space-between}
.topbar-title{font-size:22px;font-weight:700;letter-spacing:-.5px}
.topbar-title span{color:var(--gold)}
.topbar-sub{font-size:12px;color:var(--text2);font-family:'DM Mono',monospace}
.topbar-right{display:flex;align-items:center;gap:8px}
.icon-btn{width:38px;height:38px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;transition:background .2s}
.icon-btn:active{background:var(--bg4)}
.avatar{width:34px;height:34px;border-radius:10px;border:2px solid var(--gold);object-fit:cover;cursor:pointer}
.avatar-fb{width:34px;height:34px;border-radius:10px;border:2px solid var(--gold);background:var(--gold-dim);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:var(--gold);cursor:pointer}

/* SYNC BADGE */
.sync-badge{position:fixed;bottom:82px;left:50%;transform:translateX(-50%);z-index:300;background:var(--bg3);border:1px solid var(--border);border-radius:20px;padding:5px 14px;font-size:10px;font-family:'DM Mono',monospace;display:flex;align-items:center;gap:6px;pointer-events:none;white-space:nowrap;opacity:0;transition:opacity .3s}
.sync-badge.show{opacity:1}
.sync-badge.saving{color:var(--gold);border-color:rgba(245,166,35,.3)}
.sync-badge.saved{color:var(--green);border-color:rgba(46,204,113,.3)}
.sync-badge.error{color:var(--red);border-color:rgba(231,76,60,.3)}
.sync-dot{width:6px;height:6px;border-radius:50%;background:currentColor}
.sync-badge.saving .sync-dot{animation:blink .6s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}

/* BOTTOM NAV */
.bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;background:rgba(10,10,15,.96);backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;z-index:200;padding-bottom:env(safe-area-inset-bottom)}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;padding:10px 0 8px;cursor:pointer;gap:3px;position:relative}
.nav-icon{font-size:20px;transition:transform .2s}
.nav-label{font-size:10px;color:var(--text3);font-weight:500;letter-spacing:.5px;text-transform:uppercase}
.nav-item.active .nav-icon{transform:translateY(-2px)}
.nav-item.active .nav-label{color:var(--gold)}
.nav-item.active::after{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:20px;height:2px;background:var(--gold);border-radius:0 0 4px 4px}
.nav-item.add-btn .nav-icon{width:46px;height:46px;background:var(--gold);border-radius:14px;font-size:24px;display:flex;align-items:center;justify-content:center;margin-top:-12px;box-shadow:0 4px 20px rgba(245,166,35,.45)}
.nav-item.add-btn:active .nav-icon{transform:scale(.92)}
.nav-item.add-btn .nav-label{color:var(--gold)}

/* CARDS */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
.section{padding:0 16px 16px}
.section-title{font-size:11px;font-weight:600;color:var(--text3);letter-spacing:1.2px;text-transform:uppercase;margin-bottom:10px}

/* HERO */
.hero-card{margin:0 16px 20px;background:linear-gradient(135deg,#1a1a2e,#16213e 50%,#0f3460);border:1px solid rgba(245,166,35,.2);border-radius:20px;padding:24px;position:relative;overflow:hidden}
.hero-card::before{content:'';position:absolute;top:-60px;right:-60px;width:200px;height:200px;background:radial-gradient(circle,rgba(245,166,35,.12),transparent 70%)}
.hero-label{font-size:11px;color:rgba(255,255,255,.45);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px}
.hero-amount{font-size:40px;font-weight:800;letter-spacing:-2px;font-family:'DM Mono',monospace;line-height:1;margin-bottom:4px}
.hero-amount .sym{font-size:22px;font-weight:500;color:var(--gold);margin-right:2px}
.hero-month{font-size:12px;color:rgba(255,255,255,.35);margin-bottom:20px;font-family:'DM Mono',monospace}
.hero-stats{display:flex}
.hero-stat{flex:1}
.hero-stat+.hero-stat{border-left:1px solid rgba(255,255,255,.08);padding-left:16px}
.hsl{font-size:10px;color:rgba(255,255,255,.4);margin-bottom:3px;text-transform:uppercase;letter-spacing:.8px}
.hsv{font-size:16px;font-weight:600;font-family:'DM Mono',monospace}
.hsv.inc{color:var(--green)}.hsv.exp{color:var(--red)}

/* SURVIVAL */
.sur-row{display:flex;gap:10px;margin:0 16px 16px}
.sur-card{flex:1;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;text-align:center}
.sur-num{font-size:26px;font-weight:800;font-family:'DM Mono',monospace}
.sur-num.ok{color:var(--green)}.sur-num.warn{color:var(--gold)}.sur-num.crit{color:var(--red);animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.sur-lbl{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.6px;margin-top:3px}

/* PREDICT */
.predict{margin:0 16px 16px;background:linear-gradient(135deg,rgba(245,166,35,.1),rgba(245,166,35,.04));border:1px solid rgba(245,166,35,.25);border-radius:var(--radius-sm);padding:12px 14px;display:flex;align-items:flex-start;gap:10px}
.predict-ico{font-size:18px;flex-shrink:0;margin-top:2px}
.predict-txt{font-size:12px;line-height:1.6}
.predict-txt strong{color:var(--gold)}

/* METER */
.meter-track{height:6px;background:var(--bg4);border-radius:6px;overflow:hidden;margin-top:6px}
.meter-fill{height:100%;border-radius:6px;transition:width .8s cubic-bezier(.34,1.56,.64,1)}
.mf-low{background:var(--green)}.mf-mid{background:var(--gold)}.mf-high{background:var(--red);box-shadow:0 0 8px rgba(231,76,60,.5)}

/* CAT CHIPS */
.cat-scroll{display:flex;gap:10px;overflow-x:auto;padding:0 16px 4px;scrollbar-width:none}
.cat-scroll::-webkit-scrollbar{display:none}
.cat-chip{flex-shrink:0;background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:10px 14px;display:flex;flex-direction:column;align-items:center;gap:4px;min-width:70px}
.cc-i{font-size:20px}.cc-n{font-size:10px;color:var(--text2);font-weight:500}.cc-a{font-size:11px;font-weight:600;font-family:'DM Mono',monospace}

/* HEATMAP */
.hm-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-top:8px}
.hm-cell{aspect-ratio:1;border-radius:3px;background:var(--bg3)}
.hm-cell.h1{background:rgba(245,166,35,.2)}.hm-cell.h2{background:rgba(245,166,35,.4)}.hm-cell.h3{background:rgba(245,166,35,.65)}.hm-cell.h4{background:rgba(245,166,35,.9)}
.hm-cell.today{outline:2px solid var(--gold);outline-offset:1px}
.hm-days{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:3px}
.hm-day{font-size:9px;color:var(--text3);text-align:center}

/* TXN ITEMS */
.txn-item{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);cursor:pointer}
.txn-item:last-child{border-bottom:none}
.txn-icon{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.txn-info{flex:1;min-width:0}
.txn-title{font-size:14px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.txn-meta{font-size:11px;color:var(--text3);margin-top:2px;display:flex;align-items:center;gap:5px}
.mbadge{background:var(--bg4);padding:1px 6px;border-radius:4px;font-size:9px;font-family:'DM Mono',monospace}
.txn-right{display:flex;flex-direction:column;align-items:flex-end;gap:5px}
.txn-amt{font-size:15px;font-weight:600;font-family:'DM Mono',monospace}
.txn-amt.expense{color:var(--red)}.txn-amt.income{color:var(--green)}
.txn-del{font-size:15px;cursor:pointer;opacity:.4;transition:opacity .2s}
.txn-del:active{opacity:1}

/* FILTERS */
.filter-row{display:flex;gap:8px;overflow-x:auto;padding:0 16px 12px;scrollbar-width:none}
.filter-row::-webkit-scrollbar{display:none}
.filter-chip{flex-shrink:0;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:500;background:var(--bg2);border:1px solid var(--border);color:var(--text2);cursor:pointer;transition:all .2s;white-space:nowrap}
.filter-chip.active{background:var(--gold-dim);border-color:var(--gold);color:var(--gold)}
.search-bar{margin:0 16px 12px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;display:flex;align-items:center;gap:8px;padding:10px 14px}
.search-bar input{flex:1;background:none;border:none;outline:none;color:var(--text);font-family:'Sora',sans-serif;font-size:13px}
.search-bar input::placeholder{color:var(--text3)}
.txn-group{padding:0 16px}
.txn-group-label{font-size:11px;color:var(--text3);font-weight:600;padding:8px 0 4px;text-transform:uppercase;font-family:'DM Mono',monospace}

/* BUDGET SCREEN */
.budget-overview{margin:0 16px 20px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.donut-wrap{display:flex;align-items:center;gap:20px}
.donut-canvas{width:100px;height:100px;flex-shrink:0}
.donut-legend{flex:1;display:flex;flex-direction:column;gap:8px}
.leg-item{display:flex;align-items:center;gap:8px}
.leg-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.leg-lbl{font-size:12px;color:var(--text2);flex:1}
.leg-val{font-size:12px;font-family:'DM Mono',monospace;font-weight:600}
.cat-budget-list{padding:0 16px;display:flex;flex-direction:column;gap:10px}
.cb-item{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px}
.cb-top{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.cb-icon{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px}
.cb-name{flex:1;font-size:13px;font-weight:500}
.cb-amounts{text-align:right}
.cb-spent{font-size:14px;font-weight:600;font-family:'DM Mono',monospace}
.cb-of{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace}

/* GOALS */
.goal-card{margin:0 16px 12px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
.goal-top{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.goal-ico{font-size:24px}
.goal-name{font-size:14px;font-weight:600}
.goal-target{font-size:11px;color:var(--text2);font-family:'DM Mono',monospace}
.goal-pr{display:flex;justify-content:space-between;font-size:12px;font-family:'DM Mono',monospace;margin-bottom:6px}
.goal-saved{color:var(--green);font-weight:600}
.goal-eta{color:var(--text2)}

/* RECURRING */
.rec-item{display:flex;align-items:center;gap:12px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 14px;margin:0 16px 10px}
.rec-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}
.rec-info{flex:1}
.rec-name{font-size:13px;font-weight:500}
.rec-due{font-size:11px;color:var(--text3);margin-top:2px}
.rec-amt{font-size:15px;font-weight:600;font-family:'DM Mono',monospace;color:var(--red)}
.due-b{font-size:9px;padding:2px 6px;border-radius:4px;font-weight:600}
.due-b.soon{background:rgba(231,76,60,.2);color:var(--red)}.due-b.ok{background:var(--green-dim);color:var(--green)}

/* ANALYTICS */
.chart-card{margin:0 16px 16px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
.chart-title{font-size:13px;font-weight:600;margin-bottom:4px}
.chart-sub{font-size:11px;color:var(--text2);margin-bottom:14px}
.chart-wrap{position:relative;height:160px}
.chart-wrap.tall{height:200px}
.insight-card{margin:0 16px 10px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px 16px;display:flex;align-items:flex-start;gap:12px}
.insight-icon{font-size:22px;flex-shrink:0}
.insight-title{font-size:13px;font-weight:600;margin-bottom:2px}
.insight-desc{font-size:12px;color:var(--text2);line-height:1.5}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:0 16px;margin-bottom:16px}
.stat-mini{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px}
.stat-mini-lbl{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px}
.stat-mini-val{font-size:20px;font-weight:700;font-family:'DM Mono',monospace}

/* SETTINGS */
.settings-group{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:16px}
.si{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s}
.si:last-child{border-bottom:none}
.si:active{background:var(--bg3)}
.si-ico{font-size:20px;width:32px;text-align:center}
.si-text{flex:1}
.si-lbl{font-size:14px;font-weight:500}
.si-sub{font-size:11px;color:var(--text2);margin-top:1px}
.si-arr{color:var(--text3)}

/* MODALS */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);z-index:500;display:none;align-items:flex-end;justify-content:center}
.modal-overlay.open{display:flex}
.modal-sheet{background:var(--bg2);border-radius:24px 24px 0 0;width:100%;max-width:480px;max-height:92vh;overflow-y:auto;animation:slideUp .3s cubic-bezier(.34,1.2,.64,1);border:1px solid var(--border);border-bottom:none}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:40px;height:4px;background:var(--bg4);border-radius:4px;margin:12px auto 0}
.modal-header{padding:16px 20px 12px;display:flex;align-items:center;justify-content:space-between}
.modal-title{font-size:18px;font-weight:700}
.modal-close{font-size:20px;cursor:pointer;color:var(--text2);padding:4px}
.modal-body{padding:0 20px 32px}

/* ADD FORM */
.type-toggle{display:flex;background:var(--bg3);border-radius:12px;padding:4px;margin-bottom:20px}
.type-btn{flex:1;padding:8px;text-align:center;font-size:13px;font-weight:600;border-radius:9px;cursor:pointer;transition:all .2s;color:var(--text2)}
.type-btn.active.expense{background:var(--red);color:white}.type-btn.active.income{background:var(--green);color:white}
.amt-display{background:var(--bg3);border-radius:14px;padding:16px 20px;margin-bottom:16px;text-align:right}
.amt-display-lbl{font-size:11px;color:var(--text3);margin-bottom:4px}
.amt-display-val{font-size:36px;font-weight:700;font-family:'DM Mono',monospace;letter-spacing:-1px;min-height:44px}
.amt-display-val .sym{font-size:20px;color:var(--gold);margin-right:4px}
.keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}
.key{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:14px 8px;text-align:center;font-size:18px;font-weight:600;font-family:'DM Mono',monospace;cursor:pointer;transition:all .15s;user-select:none}
.key:active{background:var(--bg4);transform:scale(.95)}.key.del{background:var(--bg4);font-size:16px}
.form-field{margin-bottom:14px}
.form-label{font-size:11px;color:var(--text2);font-weight:600;letter-spacing:.8px;text-transform:uppercase;margin-bottom:6px;display:block}
.form-input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:11px 14px;color:var(--text);font-family:'Sora',sans-serif;font-size:14px;outline:none;transition:border-color .2s}
.form-input:focus{border-color:var(--gold)}
.cat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.cat-item{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:10px 6px;text-align:center;cursor:pointer;transition:all .2s}
.cat-item .ci{font-size:20px}.cat-item .cn{font-size:9px;color:var(--text3);margin-top:3px}
.cat-item.sel{border-color:var(--gold);background:var(--gold-dim)}.cat-item.sel .cn{color:var(--gold)}
.method-row{display:flex;gap:8px;flex-wrap:wrap}
.method-chip{padding:6px 14px;border-radius:20px;border:1px solid var(--border);background:var(--bg3);font-size:12px;color:var(--text2);cursor:pointer;transition:all .2s}
.method-chip.sel{border-color:var(--gold);color:var(--gold);background:var(--gold-dim)}
.save-btn{width:100%;background:var(--gold);color:#0a0a0f;border:none;border-radius:14px;padding:16px;font-size:15px;font-weight:700;font-family:'Sora',sans-serif;cursor:pointer;margin-top:8px;transition:all .2s}
.save-btn:active{transform:scale(.98);background:var(--gold2)}
.save-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
.bud-inp-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.bud-inp-row .bci{font-size:22px;width:36px;text-align:center}
.bud-inp-row .bcn{flex:1;font-size:13px}
.bud-inp-row input{width:100px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:8px 10px;color:var(--text);font-family:'DM Mono',monospace;font-size:13px;text-align:right;outline:none}
.bud-inp-row input:focus{border-color:var(--gold)}

/* CONFIRM */
.modal-overlay.confirm{align-items:center;justify-content:center}
.confirm-box{background:var(--bg2);border-radius:20px;padding:24px;width:calc(100% - 60px);max-width:320px;text-align:center;border:1px solid var(--border);animation:popIn .25s cubic-bezier(.34,1.4,.64,1)}
@keyframes popIn{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}
.ci-ico{font-size:40px;margin-bottom:12px}
.ci-title{font-size:16px;font-weight:700;margin-bottom:6px}
.ci-sub{font-size:13px;color:var(--text2);margin-bottom:20px;line-height:1.5}
.ci-btns{display:flex;gap:10px}
.ci-btns button{flex:1;padding:12px;border-radius:12px;border:none;font-family:'Sora',sans-serif;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s}
.btn-cancel{background:var(--bg3);color:var(--text)}
.btn-action{color:white}

/* TOAST */
.toast{position:fixed;bottom:82px;left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:10px 20px;font-size:13px;font-weight:500;z-index:1000;white-space:nowrap;opacity:0;transition:opacity .3s;pointer-events:none}
.toast.show{opacity:1}

/* EMPTY */
.empty{text-align:center;padding:40px 20px;color:var(--text3)}
.empty-ico{font-size:48px;margin-bottom:12px}
.empty-title{font-size:16px;font-weight:600;color:var(--text2);margin-bottom:6px}
.empty-sub{font-size:13px;line-height:1.5}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading-screen">
  <div class="spinner"></div>
  <div class="loading-text">Loading Paisa...</div>
</div>

<!-- LOGIN -->
<div id="login-screen" class="gone">
  <div class="login-glow"></div>
  <div class="login-logo">ğŸ’°</div>
  <div class="login-appname">Pai<span>sa</span></div>
  <div class="login-tagline">Your personal finance tracker.<br>Private â€” only you can access this.</div>
  <div class="login-card">
    <div class="login-card-title">Welcome back</div>
    <div class="login-card-sub">Sign in with your authorised Google account to access your financial data.</div>
    <button class="google-btn" id="google-btn" onclick="signInGoogle()">
      <svg class="google-svg" viewBox="0 0 24 24">
        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
      Continue with Google
    </button>
    <div class="login-lock">ğŸ”’ Private access only</div>
  </div>
</div>

<!-- ACCESS DENIED -->
<div id="denied-screen">
  <div class="denied-icon">ğŸš«</div>
  <div class="denied-title">Access Denied</div>
  <div class="denied-sub">This app is private. The account you used is not authorised to access it.</div>
  <div class="denied-badge" id="denied-email"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="2e5b4045404159406e49434f4742004d4143">[email&#160;protected]</a></div>
  <button class="denied-btn" onclick="tryAgain()">â† Use a different account</button>
</div>

<!-- SYNC -->
<div class="sync-badge" id="sync-badge">
  <div class="sync-dot"></div>
  <span id="sync-text">Saving...</span>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="main-app">

  <!-- DASHBOARD -->
  <div class="screen active" id="screen-dashboard">
    <div class="topbar">
      <div>
        <div class="topbar-title">Pai<span>sa</span> ğŸ’°</div>
        <div class="topbar-sub" id="dash-date"></div>
      </div>
      <div class="topbar-right">
        <div class="icon-btn" onclick="openBudgetModal()">âš™ï¸</div>
        <div id="avatar-wrap" onclick="doSignOut()"></div>
      </div>
    </div>

    <div class="hero-card">
      <div class="hero-label">Monthly Balance</div>
      <div class="hero-amount"><span class="sym">â‚¹</span><span id="hero-balance">0</span></div>
      <div class="hero-month" id="hero-month"></div>
      <div class="hero-stats">
        <div class="hero-stat"><div class="hsl">Income</div><div class="hsv inc" id="hero-inc">â‚¹0</div></div>
        <div class="hero-stat"><div class="hsl">Spent</div><div class="hsv exp" id="hero-exp">â‚¹0</div></div>
        <div class="hero-stat"><div class="hsl">Today</div><div class="hsv" id="hero-today" style="color:var(--gold)">â‚¹0</div></div>
      </div>
    </div>

    <div class="sur-row">
      <div class="sur-card"><div class="sur-num ok" id="sur-days">â€“</div><div class="sur-lbl">Days Left</div></div>
      <div class="sur-card"><div class="sur-num warn" id="sur-burn">â€“</div><div class="sur-lbl">Daily Burn</div></div>
      <div class="sur-card"><div class="sur-num" id="sur-score" style="color:var(--green)">â€“</div><div class="sur-lbl">Health Score</div></div>
    </div>

    <div class="predict">
      <div class="predict-ico">ğŸ¤–</div>
      <div class="predict-txt" id="predict-txt">Crunching your numbers...</div>
    </div>

    <div class="section">
      <div class="section-title">Monthly Budget</div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <span style="font-size:13px;color:var(--text2)">Total Spent</span>
          <span style="font-size:13px;font-family:'DM Mono',monospace;font-weight:600" id="bud-pct">0%</span>
        </div>
        <div class="meter-track"><div class="meter-fill mf-low" id="bud-fill" style="width:0%"></div></div>
        <div style="display:flex;justify-content:space-between;margin-top:6px">
          <span style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace" id="bud-spent">â‚¹0 spent</span>
          <span style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace" id="bud-left">â‚¹0 left</span>
        </div>
      </div>
    </div>

    <div class="section"><div class="section-title">This Month by Category</div></div>
    <div class="cat-scroll" id="cat-scroll"></div>
    <div style="height:14px"></div>

    <div class="section">
      <div class="section-title">Expense Heatmap â€” Last 5 Weeks</div>
      <div class="card">
        <div class="hm-days">
          <div class="hm-day">S</div><div class="hm-day">M</div><div class="hm-day">T</div>
          <div class="hm-day">W</div><div class="hm-day">T</div><div class="hm-day">F</div><div class="hm-day">S</div>
        </div>
        <div class="hm-grid" id="hm-grid"></div>
        <div style="display:flex;align-items:center;gap:6px;margin-top:10px;justify-content:flex-end">
          <span style="font-size:10px;color:var(--text3)">Less</span>
          <div style="width:10px;height:10px;border-radius:2px;background:var(--bg3)"></div>
          <div style="width:10px;height:10px;border-radius:2px;background:rgba(245,166,35,.25)"></div>
          <div style="width:10px;height:10px;border-radius:2px;background:rgba(245,166,35,.55)"></div>
          <div style="width:10px;height:10px;border-radius:2px;background:rgba(245,166,35,.9)"></div>
          <span style="font-size:10px;color:var(--text3)">More</span>
        </div>
      </div>
    </div>

    <div class="section">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="section-title" style="margin-bottom:0">Recent</div>
        <span style="font-size:12px;color:var(--gold);cursor:pointer" onclick="switchScreen('transactions')">See all â†’</span>
      </div>
    </div>
    <div style="padding:0 16px" id="recent-list"></div>
  </div>

  <!-- TRANSACTIONS -->
  <div class="screen" id="screen-transactions">
    <div class="topbar">
      <div class="topbar-title">Transactions</div>
      <div class="icon-btn" onclick="openModal('export-modal')">ğŸ“¤</div>
    </div>
    <div class="search-bar"><span>ğŸ”</span><input type="text" placeholder="Search transactions..." id="txn-search" oninput="renderTxns()"></div>
    <div class="filter-row">
      <div class="filter-chip active" onclick="setFilter(this,'all')">All</div>
      <div class="filter-chip" onclick="setFilter(this,'expense')">Expenses</div>
      <div class="filter-chip" onclick="setFilter(this,'income')">Income</div>
      <div class="filter-chip" onclick="setFilter(this,'food')">ğŸ• Food</div>
      <div class="filter-chip" onclick="setFilter(this,'transport')">ğŸš— Transport</div>
      <div class="filter-chip" onclick="setFilter(this,'shopping')">ğŸ›ï¸ Shopping</div>
      <div class="filter-chip" onclick="setFilter(this,'bills')">ğŸ’¡ Bills</div>
      <div class="filter-chip" onclick="setFilter(this,'health')">ğŸ¥ Health</div>
      <div class="filter-chip" onclick="setFilter(this,'entertainment')">ğŸ¬ Fun</div>
    </div>
    <div id="txn-list"></div>
  </div>

  <!-- BUDGET -->
  <div class="screen" id="screen-budget">
    <div class="topbar"><div class="topbar-title">Budget & Goals</div><div class="icon-btn" onclick="openBudgetModal()">âœï¸</div></div>
    <div class="budget-overview">
      <div class="donut-wrap">
        <canvas class="donut-canvas" id="donut-chart"></canvas>
        <div class="donut-legend" id="donut-legend"></div>
      </div>
    </div>
    <div class="section"><div class="section-title">Category Budgets</div></div>
    <div class="cat-budget-list" id="cat-budget-list"></div>
    <div class="section" style="margin-top:8px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="section-title" style="margin-bottom:0">Savings Goals</div>
        <span style="font-size:12px;color:var(--gold);cursor:pointer" onclick="openModal('goals-modal')">ï¼‹ Add</span>
      </div>
    </div>
    <div id="goals-list"></div>
    <div class="section" style="margin-top:8px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="section-title" style="margin-bottom:0">Recurring & Subscriptions</div>
        <span style="font-size:12px;color:var(--gold);cursor:pointer" onclick="openModal('rec-modal')">ï¼‹ Add</span>
      </div>
    </div>
    <div id="rec-list"></div>
  </div>

  <!-- ANALYTICS -->
  <div class="screen" id="screen-analytics">
    <div class="topbar"><div class="topbar-title">Analytics</div></div>
    <div class="stats-grid" id="stats-grid"></div>
    <div class="chart-card"><div class="chart-title">Daily Spending â€” Last 30 Days</div><div class="chart-sub" id="daily-sub"></div><div class="chart-wrap"><canvas id="chart-daily"></canvas></div></div>
    <div class="chart-card"><div class="chart-title">Category Breakdown</div><div class="chart-sub">This month's distribution</div><div class="chart-wrap tall"><canvas id="chart-cat"></canvas></div></div>
    <div class="chart-card"><div class="chart-title">Income vs Expense</div><div class="chart-sub">Last 6 months</div><div class="chart-wrap"><canvas id="chart-compare"></canvas></div></div>
    <div class="section"><div class="section-title">Smart Insights</div></div>
    <div id="insights-list"></div>
  </div>

  <!-- SETTINGS -->
  <div class="screen" id="screen-settings">
    <div class="topbar"><div class="topbar-title">Settings</div></div>
    <div class="section">
      <div class="card" style="display:flex;align-items:center;gap:14px;padding:16px">
        <div id="settings-avatar" style="width:52px;height:52px;border-radius:16px;border:2px solid var(--gold);overflow:hidden;display:flex;align-items:center;justify-content:center;background:var(--gold-dim);font-size:18px;font-weight:700;color:var(--gold)"></div>
        <div><div style="font-size:16px;font-weight:700" id="settings-name">â€“</div><div style="font-size:12px;color:var(--text2)" id="settings-email">â€“</div></div>
      </div>
    </div>
    <div style="padding:0 16px">
      <div class="section-title">Finance</div>
      <div class="settings-group">
        <div class="si" onclick="openBudgetModal()"><div class="si-ico">ğŸ¯</div><div class="si-text"><div class="si-lbl">Set Budgets</div><div class="si-sub">Monthly limits per category</div></div><div class="si-arr">â€º</div></div>
        <div class="si" onclick="openModal('goals-modal')"><div class="si-ico">ğŸ†</div><div class="si-text"><div class="si-lbl">Savings Goals</div><div class="si-sub">Track financial targets</div></div><div class="si-arr">â€º</div></div>
      </div>
      <div class="section-title">Export</div>
      <div class="settings-group">
        <div class="si" onclick="exportExcel()"><div class="si-ico">ğŸ“Š</div><div class="si-text"><div class="si-lbl">Export Excel (.xlsx)</div><div class="si-sub">All transactions spreadsheet</div></div><div class="si-arr">â€º</div></div>
        <div class="si" onclick="exportCSV()"><div class="si-ico">ğŸ“</div><div class="si-text"><div class="si-lbl">Export CSV</div><div class="si-sub">Raw data file</div></div><div class="si-arr">â€º</div></div>
      </div>
      <div class="section-title">Danger Zone</div>
      <div class="settings-group">
        <div class="si" onclick="clearAll()"><div class="si-ico">ğŸ—‘ï¸</div><div class="si-text"><div class="si-lbl" style="color:var(--red)">Clear All Transactions</div><div class="si-sub">Permanently delete all data from Firestore</div></div><div class="si-arr">â€º</div></div>
        <div class="si" onclick="doSignOut()"><div class="si-ico">ğŸšª</div><div class="si-text"><div class="si-lbl" style="color:var(--red)">Sign Out</div><div class="si-sub">Log out of this device</div></div><div class="si-arr">â€º</div></div>
      </div>
    </div>
    <div style="text-align:center;padding:24px 20px;color:var(--text3);font-size:11px;font-family:'DM Mono',monospace">
      Paisa Â· Firebase Firestore Â· Private Access Only ğŸ”’
    </div>
  </div>

  <nav class="bottom-nav">
    <div class="nav-item active" id="nav-dashboard" onclick="switchScreen('dashboard')"><div class="nav-icon">ğŸ </div><div class="nav-label">Home</div></div>
    <div class="nav-item" id="nav-transactions" onclick="switchScreen('transactions')"><div class="nav-icon">ğŸ“‹</div><div class="nav-label">Txns</div></div>
    <div class="nav-item add-btn" onclick="openAddModal()"><div class="nav-icon">ï¼‹</div><div class="nav-label">Add</div></div>
    <div class="nav-item" id="nav-budget" onclick="switchScreen('budget')"><div class="nav-icon">ğŸ¯</div><div class="nav-label">Budget</div></div>
    <div class="nav-item" id="nav-analytics" onclick="switchScreen('analytics')"><div class="nav-icon">ğŸ“ˆ</div><div class="nav-label">Analytics</div></div>
  </nav>
</div>

<!-- ADD/EDIT MODAL -->
<div class="modal-overlay" id="add-modal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-header"><div class="modal-title" id="add-title">Add Transaction</div><div class="modal-close" onclick="closeModal('add-modal')">âœ•</div></div>
    <div class="modal-body">
      <div class="type-toggle">
        <div class="type-btn active expense" id="type-exp" onclick="setType('expense')">ğŸ’¸ Expense</div>
        <div class="type-btn income" id="type-inc" onclick="setType('income')">ğŸ’° Income</div>
      </div>
      <div class="amt-display">
        <div class="amt-display-lbl">Amount</div>
        <div class="amt-display-val"><span class="sym">â‚¹</span><span id="amt-disp">0</span></div>
      </div>
      <div class="keypad">
        <div class="key" onclick="kp('7')">7</div><div class="key" onclick="kp('8')">8</div><div class="key" onclick="kp('9')">9</div>
        <div class="key" onclick="kp('4')">4</div><div class="key" onclick="kp('5')">5</div><div class="key" onclick="kp('6')">6</div>
        <div class="key" onclick="kp('1')">1</div><div class="key" onclick="kp('2')">2</div><div class="key" onclick="kp('3')">3</div>
        <div class="key" onclick="kp('0')">0</div><div class="key" onclick="kp('.')">.</div><div class="key del" onclick="kp('del')">âŒ«</div>
      </div>
      <div class="form-field"><label class="form-label">Category</label><div class="cat-grid" id="cat-grid"></div></div>
      <div class="form-field"><label class="form-label">Note</label><input type="text" class="form-input" id="add-note" placeholder="What was this for?" maxlength="60"></div>
      <div class="form-field">
        <label class="form-label">Payment Method</label>
        <div class="method-row">
          <div class="method-chip sel" data-m="UPI" onclick="selM(this)">UPI</div>
          <div class="method-chip" data-m="Cash" onclick="selM(this)">Cash</div>
          <div class="method-chip" data-m="Card" onclick="selM(this)">Card</div>
          <div class="method-chip" data-m="Bank" onclick="selM(this)">Bank</div>
          <div class="method-chip" data-m="Wallet" onclick="selM(this)">Wallet</div>
        </div>
      </div>
      <div class="form-field"><label class="form-label">Date</label><input type="date" class="form-input" id="add-date"></div>
      <button class="save-btn" id="save-btn" onclick="saveTxn()">Save Transaction</button>
    </div>
  </div>
</div>

<!-- BUDGET MODAL -->
<div class="modal-overlay" id="budget-modal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-header"><div class="modal-title">Set Monthly Budgets</div><div class="modal-close" onclick="closeModal('budget-modal')">âœ•</div></div>
    <div class="modal-body">
      <div class="form-field"><label class="form-label">Total Monthly Budget (â‚¹)</label><input type="number" class="form-input" id="total-bud" placeholder="30000"></div>
      <div class="form-field"><label class="form-label">Per Category Limits</label><div id="cat-bud-inputs"></div></div>
      <button class="save-btn" onclick="saveBudgets()">Save Budgets</button>
    </div>
  </div>
</div>

<!-- GOALS MODAL -->
<div class="modal-overlay" id="goals-modal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-header"><div class="modal-title">Add Savings Goal</div><div class="modal-close" onclick="closeModal('goals-modal')">âœ•</div></div>
    <div class="modal-body">
      <div class="form-field"><label class="form-label">Goal Name</label><input type="text" class="form-input" id="goal-name" placeholder="e.g. Bike Fund"></div>
      <div class="form-field"><label class="form-label">Target Amount (â‚¹)</label><input type="number" class="form-input" id="goal-target" placeholder="50000"></div>
      <div class="form-field"><label class="form-label">Already Saved (â‚¹)</label><input type="number" class="form-input" id="goal-saved" placeholder="0"></div>
      <div class="form-field">
        <label class="form-label">Icon</label>
        <div style="display:flex;gap:10px;flex-wrap:wrap" id="goal-icons">
          <span style="font-size:26px;cursor:pointer;padding:4px;border-radius:6px" onclick="selGI(this)">ğŸ¯</span>
          <span style="font-size:26px;cursor:pointer;padding:4px;border-radius:6px" onclick="selGI(this)">ğŸï¸</span>
          <span style="font-size:26px;cursor:pointer;padding:4px;border-radius:6px" onclick="selGI(this)">âœˆï¸</span>
          <span style="font-size:26px;cursor:pointer;padding:4px;border-radius:6px" onclick="selGI(this)">ğŸ </span>
          <span style="font-size:26px;cursor:pointer;padding:4px;border-radius:6px" onclick="selGI(this)">ğŸ’»</span>
          <span style="font-size:26px;cursor:pointer;padding:4px;border-radius:6px" onclick="selGI(this)">ğŸš—</span>
          <span style="font-size:26px;cursor:pointer;padding:4px;border-radius:6px" onclick="selGI(this)">ğŸ’</span>
          <span style="font-size:26px;cursor:pointer;padding:4px;border-radius:6px" onclick="selGI(this)">ğŸ“</span>
        </div>
      </div>
      <button class="save-btn" onclick="saveGoal()">Add Goal</button>
    </div>
  </div>
</div>

<!-- EXPORT -->
<div class="modal-overlay" id="export-modal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-header"><div class="modal-title">Export Data</div><div class="modal-close" onclick="closeModal('export-modal')">âœ•</div></div>
    <div class="modal-body" style="display:flex;flex-direction:column;gap:12px">
      <button class="save-btn" style="background:var(--green)" onclick="exportExcel();closeModal('export-modal')">ğŸ“Š Export Excel (.xlsx)</button>
      <button class="save-btn" style="background:var(--bg3);color:var(--text)" onclick="exportCSV();closeModal('export-modal')">ğŸ“ Export CSV</button>
    </div>
  </div>
</div>

<!-- ADD RECURRING MODAL -->
<div class="modal-overlay" id="rec-modal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-header"><div class="modal-title">Add Recurring Item</div><div class="modal-close" onclick="closeModal('rec-modal')">âœ•</div></div>
    <div class="modal-body">
      <div class="form-field"><label class="form-label">Name</label><input type="text" class="form-input" id="rec-inp-name" placeholder="e.g. Netflix, Rent, SIP"></div>
      <div class="form-field"><label class="form-label">Amount (â‚¹)</label><input type="number" class="form-input" id="rec-inp-amount" placeholder="649"></div>
      <div class="form-field"><label class="form-label">Due Day of Month (1â€“31)</label><input type="number" class="form-input" id="rec-inp-day" placeholder="15" min="1" max="31"></div>
      <div class="form-field"><label class="form-label">Icon (emoji)</label><input type="text" class="form-input" id="rec-inp-icon" placeholder="ğŸ¬" maxlength="4"></div>
      <button class="save-btn" onclick="saveRecurring()">Add Recurring Item</button>
    </div>
  </div>
</div>

<!-- CONFIRM -->
<div class="modal-overlay confirm" id="confirm-modal">
  <div class="confirm-box">
    <div class="ci-ico" id="ci-ico">âš ï¸</div>
    <div class="ci-title" id="ci-title">Are you sure?</div>
    <div class="ci-sub" id="ci-sub">This cannot be undone.</div>
    <div class="ci-btns">
      <button class="btn-cancel" onclick="closeModal('confirm-modal')">Cancel</button>
      <button class="btn-action" id="ci-action">Confirm</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// â”€â”€ Categories â”€â”€
const CATS=[
  {id:'food',name:'Food',icon:'ğŸ•',color:'#e74c3c'},
  {id:'transport',name:'Transport',icon:'ğŸš—',color:'#3498db'},
  {id:'shopping',name:'Shopping',icon:'ğŸ›ï¸',color:'#9b59b6'},
  {id:'bills',name:'Bills',icon:'ğŸ’¡',color:'#f39c12'},
  {id:'emi',name:'EMI',icon:'ğŸ¦',color:'#c0392b'},
  {id:'rent',name:'Rent',icon:'ğŸ ',color:'#2ecc71'},
  {id:'health',name:'Health',icon:'ğŸ¥',color:'#1abc9c'},
  {id:'entertainment',name:'Fun',icon:'ğŸ¬',color:'#e91e63'},
  {id:'travel',name:'Travel',icon:'âœˆï¸',color:'#00bcd4'},
  {id:'education',name:'Education',icon:'ğŸ“š',color:'#ff9800'},
  {id:'salary',name:'Salary',icon:'ğŸ’¼',color:'#2ecc71'},
  {id:'others',name:'Others',icon:'ğŸ“¦',color:'#607d8b'},
];
const getCat=id=>CATS.find(c=>c.id===id)||CATS[11];

// â”€â”€ State â”€â”€
let txns=[],budgets={total:30000,cats:{}},goals=[],recurring=[];
let editId=null,txnType='expense',amtStr='',selCat='food',selMethod='UPI',selGoalIco='ğŸ¯';
let curFilter='all',charts={},activeScreen='dashboard';
let unsubTxns,unsubBudgets,unsubGoals,unsubRecurring;

// â”€â”€ Helpers â”€â”€
const fmt=n=>Number(n).toLocaleString('en-IN');
const fmtDate=iso=>new Date(iso).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'});
const todayStr=()=>{const d=new Date();return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')};
const isThisMonth=iso=>{const d=new Date(iso),n=new Date();return d.getFullYear()===n.getFullYear()&&d.getMonth()===n.getMonth()};
const isToday=iso=>iso.slice(0,10)===todayStr();
const monthExp=()=>txns.filter(t=>t.type==='expense'&&isThisMonth(t.date));
const monthInc=()=>txns.filter(t=>t.type==='income'&&isThisMonth(t.date));
const sum=a=>a.reduce((s,t)=>s+t.amount,0);

function toast(msg,d=2500){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),d)}
function syncBadge(s){
  const b=document.getElementById('sync-badge'),t=document.getElementById('sync-text');
  b.className='sync-badge show '+s;
  t.textContent={saving:'Saving to Firebaseâ€¦',saved:'Saved âœ“',error:'Save failed!'}[s];
  if(s==='saved')setTimeout(()=>b.classList.remove('show'),2000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH + EMAIL WHITELIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('firebase-ready',()=>{
  const {auth,onAuthStateChanged,ALLOWED_EMAIL}=window._fb;

  onAuthStateChanged(auth,user=>{
    document.getElementById('loading-screen').classList.add('gone');

    if(!user){
      // Not logged in â†’ show login
      document.getElementById('login-screen').classList.remove('gone');
      document.getElementById('main-app').classList.remove('on');
      document.getElementById('denied-screen').classList.remove('show');
      return;
    }

    // â”€â”€ WHITELIST CHECK â”€â”€
    // Sign out immediately if wrong email, show denied screen
    if(user.email.toLowerCase()!==ALLOWED_EMAIL.toLowerCase()){
      const {signOut}=window._fb;
      signOut(auth); // kick them out silently
      document.getElementById('login-screen').classList.add('gone');
      document.getElementById('main-app').classList.remove('on');
      document.getElementById('denied-email').textContent=user.email;
      document.getElementById('denied-screen').classList.add('show');
      return;
    }

    // â”€â”€ AUTHORISED â€” load the app â”€â”€
    document.getElementById('login-screen').classList.add('gone');
    document.getElementById('denied-screen').classList.remove('show');
    document.getElementById('main-app').classList.add('on');
    updateAvatarUI(user);
    subscribeAll();
  });
});

function signInGoogle(){
  if(!window._fb){const btn=document.getElementById('google-btn');btn.textContent='Initialisingâ€¦';setTimeout(signInGoogle,300);return;}
  const {auth,GoogleAuthProvider,signInWithPopup}=window._fb;
  const btn=document.getElementById('google-btn');
  btn.disabled=true;btn.textContent='Signing inâ€¦';
  signInWithPopup(auth,new GoogleAuthProvider()).catch(err=>{
    toast('âŒ '+err.message);
    btn.disabled=false;
    btn.innerHTML=`<svg class="google-svg" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>Continue with Google`;
  });
}

function tryAgain(){
  document.getElementById('denied-screen').classList.remove('show');
  document.getElementById('login-screen').classList.remove('gone');
  const btn=document.getElementById('google-btn');btn.disabled=false;
}

function doSignOut(){
  confirm2('ğŸšª','Sign Out?','You will be logged out of this device.','Sign Out','#e74c3c',()=>{
    if(unsubTxns)unsubTxns();if(unsubBudgets)unsubBudgets();if(unsubGoals)unsubGoals();if(unsubRecurring)unsubRecurring();
    window._fb.signOut(window._fb.auth);
    closeModal('confirm-modal');
  });
}

function updateAvatarUI(user){
  const name=user.displayName||'Owner';
  const inits=name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
  document.getElementById('settings-name').textContent=name;
  document.getElementById('settings-email').textContent=user.email||'';
  const aw=document.getElementById('avatar-wrap'),sa=document.getElementById('settings-avatar');
  if(user.photoURL){
    aw.innerHTML=`<img src="${user.photoURL}" class="avatar" title="Tap to sign out" onerror="this.outerHTML='<div class=avatar-fb>${inits}</div>'">`;
    sa.innerHTML=`<img src="${user.photoURL}" style="width:100%;height:100%;object-fit:cover">`;
  }else{
    aw.innerHTML=`<div class="avatar-fb" title="Tap to sign out">${inits}</div>`;
    sa.textContent=inits;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIRESTORE SUBSCRIPTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function subscribeAll(){
  const {db,collection,doc,onSnapshot,query,orderBy}=window._fb;

  unsubTxns=onSnapshot(
    query(collection(db,'transactions'),orderBy('date','desc')),
    snap=>{
      txns=snap.docs.map(d=>({id:d.id,...d.data()}));
      renderDashboard();
      if(activeScreen==='transactions')renderTxns();
      if(activeScreen==='budget')renderBudget();
      if(activeScreen==='analytics')renderAnalytics();
    },
    err=>{console.error(err);toast('âŒ Firestore: '+err.message);}
  );

  unsubBudgets=onSnapshot(doc(db,'settings','budgets'),snap=>{
    if(snap.exists()){budgets=snap.data();renderDashboard();}
  });

  unsubGoals=onSnapshot(collection(db,'goals'),snap=>{
    goals=snap.docs.map(d=>({id:d.id,...d.data()}));
    if(activeScreen==='budget')renderBudget();
  });

  unsubRecurring=onSnapshot(collection(db,'recurring'),snap=>{
    recurring=snap.docs.map(d=>({id:d.id,...d.data()}));
    if(activeScreen==='budget')renderBudget();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SCREENS=['dashboard','transactions','budget','analytics','settings'];
function switchScreen(id){
  activeScreen=id;
  SCREENS.forEach(s=>{
    document.getElementById('screen-'+s).classList.remove('active');
    const n=document.getElementById('nav-'+s);if(n)n.classList.remove('active');
  });
  document.getElementById('screen-'+id).classList.add('active');
  const n=document.getElementById('nav-'+id);if(n)n.classList.add('active');
  if(id==='dashboard')renderDashboard();
  if(id==='transactions')renderTxns();
  if(id==='budget')renderBudget();
  if(id==='analytics')renderAnalytics();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id){document.getElementById(id).classList.add('open')}
function closeModal(id){document.getElementById(id).classList.remove('open')}
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o&&!o.classList.contains('confirm'))o.classList.remove('open')}));

function confirm2(ico,title,sub,label,color,fn){
  document.getElementById('ci-ico').textContent=ico;
  document.getElementById('ci-title').textContent=title;
  document.getElementById('ci-sub').textContent=sub;
  const btn=document.getElementById('ci-action');
  btn.textContent=label;btn.style.background=color;btn.onclick=fn;
  openModal('confirm-modal');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD / EDIT TRANSACTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAddModal(t=null){
  editId=t?t.id:null; amtStr=t?String(t.amount):''; txnType=t?t.type:'expense';
  selCat=t?t.category:'food'; selMethod=t?t.method:'UPI';
  document.getElementById('add-title').textContent=t?'Edit Transaction':'Add Transaction';
  document.getElementById('add-note').value=t?t.note:'';
  document.getElementById('add-date').value=t?t.date.slice(0,10):todayStr();
  refreshAmt();refreshTypeUI();refreshCatGrid();
  document.querySelectorAll('.method-chip').forEach(c=>c.classList.toggle('sel',c.dataset.m===selMethod));
  openModal('add-modal');
}
function setType(t){txnType=t;refreshTypeUI();refreshCatGrid();}
function refreshTypeUI(){
  document.getElementById('type-exp').className='type-btn'+(txnType==='expense'?' active expense':'');
  document.getElementById('type-inc').className='type-btn'+(txnType==='income'?' active income':'');
}
function kp(k){
  if(k==='del')amtStr=amtStr.slice(0,-1);
  else if(k==='.')amtStr.includes('.')||(amtStr+='.');
  else{if(amtStr.length>=8)return;amtStr+=k;}
  refreshAmt();
}
function refreshAmt(){document.getElementById('amt-disp').textContent=amtStr||'0';}
function refreshCatGrid(){
  const cats=txnType==='income'?CATS.filter(c=>['salary','others'].includes(c.id)):CATS.filter(c=>c.id!=='salary');
  if(!cats.find(c=>c.id===selCat))selCat=cats[0].id;
  document.getElementById('cat-grid').innerHTML=cats.map(c=>`
    <div class="cat-item${selCat===c.id?' sel':''}" onclick="selC('${c.id}')">
      <div class="ci">${c.icon}</div><div class="cn">${c.name}</div>
    </div>`).join('');
}
function selC(id){
  selCat=id;
  document.querySelectorAll('.cat-item').forEach(el=>{
    const ico=el.querySelector('.ci')?.textContent;
    el.classList.toggle('sel',CATS.find(c=>c.icon===ico)?.id===id);
  });
}
function selM(el){
  selMethod=el.dataset.m;
  document.querySelectorAll('.method-chip').forEach(c=>c.classList.remove('sel'));
  el.classList.add('sel');
}

async function saveTxn(){
  const amount=parseFloat(amtStr);
  if(!amount||amount<=0){toast('âš ï¸ Enter a valid amount');return;}
  const {db,collection,doc,addDoc,setDoc,serverTimestamp}=window._fb;
  const note=document.getElementById('add-note').value.trim()||getCat(selCat).name;
  const date=document.getElementById('add-date').value||todayStr();
  const data={type:txnType,amount,category:selCat,note,method:selMethod,date:new Date(date).toISOString(),updatedAt:serverTimestamp()};
  const btn=document.getElementById('save-btn');
  btn.disabled=true;btn.textContent='Savingâ€¦';syncBadge('saving');
  try{
    if(editId){await setDoc(doc(db,'transactions',editId),data,{merge:true});toast('âœ… Updated');}
    else{data.createdAt=serverTimestamp();await addDoc(collection(db,'transactions'),data);toast('âœ… Saved');}
    syncBadge('saved');closeModal('add-modal');
  }catch(err){syncBadge('error');toast('âŒ '+err.message);}
  finally{btn.disabled=false;btn.textContent='Save Transaction';}
}

function deleteTxn(id){
  confirm2('ğŸ—‘ï¸','Delete Transaction?','This will be removed from Firebase permanently.','Delete','#e74c3c',async()=>{
    const{db,doc,deleteDoc}=window._fb;
    syncBadge('saving');
    try{await deleteDoc(doc(db,'transactions',id));syncBadge('saved');toast('ğŸ—‘ï¸ Deleted');}
    catch(err){syncBadge('error');toast('âŒ '+err.message);}
    closeModal('confirm-modal');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUDGETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openBudgetModal(){
  document.getElementById('total-bud').value=budgets.total||30000;
  document.getElementById('cat-bud-inputs').innerHTML=CATS.filter(c=>c.id!=='salary').map(c=>`
    <div class="bud-inp-row">
      <div class="bci">${c.icon}</div><div class="bcn">${c.name}</div>
      <input type="number" placeholder="0" id="cb-${c.id}" value="${budgets.cats?.[c.id]||''}">
    </div>`).join('');
  openModal('budget-modal');
}
async function saveBudgets(){
  const{db,doc,setDoc}=window._fb;
  const nb={total:parseFloat(document.getElementById('total-bud').value)||30000,cats:{}};
  CATS.filter(c=>c.id!=='salary').forEach(c=>{const v=parseFloat(document.getElementById('cb-'+c.id)?.value)||0;if(v>0)nb.cats[c.id]=v;});
  syncBadge('saving');
  try{await setDoc(doc(db,'settings','budgets'),nb);budgets=nb;syncBadge('saved');closeModal('budget-modal');toast('âœ… Budgets saved');renderDashboard();}
  catch(err){syncBadge('error');toast('âŒ '+err.message);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selGI(el){
  selGoalIco=el.textContent;
  document.querySelectorAll('#goal-icons span').forEach(s=>{s.style.background='';s.style.outline='';});
  el.style.background='var(--gold-dim)';el.style.outline='2px solid var(--gold)';el.style.borderRadius='6px';
}
async function saveGoal(){
  const name=document.getElementById('goal-name').value.trim();
  const target=parseFloat(document.getElementById('goal-target').value);
  const saved=parseFloat(document.getElementById('goal-saved').value)||0;
  if(!name||!target){toast('âš ï¸ Fill all fields');return;}
  const{db,collection,addDoc,serverTimestamp}=window._fb;
  syncBadge('saving');
  try{
    await addDoc(collection(db,'goals'),{name,icon:selGoalIco,target,saved,createdAt:serverTimestamp()});
    syncBadge('saved');closeModal('goals-modal');toast('ğŸ† Goal added!');
    document.getElementById('goal-name').value='';document.getElementById('goal-target').value='';document.getElementById('goal-saved').value='';
  }catch(err){syncBadge('error');toast('âŒ '+err.message);}
}

// â”€â”€ Delete goal â”€â”€
function deleteGoal(id){
  confirm2('ğŸ—‘ï¸','Delete Goal?','This savings goal will be permanently removed.','Delete','#e74c3c',async()=>{
    const{db,doc,deleteDoc}=window._fb;
    syncBadge('saving');
    try{await deleteDoc(doc(db,'goals',id));syncBadge('saved');toast('ğŸ—‘ï¸ Goal deleted');}
    catch(err){syncBadge('error');toast('âŒ '+err.message);}
    closeModal('confirm-modal');
  });
}

// â”€â”€ Add / Delete recurring â”€â”€
async function saveRecurring(){
  const name=document.getElementById('rec-inp-name').value.trim();
  const amount=parseFloat(document.getElementById('rec-inp-amount').value);
  const dueDay=parseInt(document.getElementById('rec-inp-day').value);
  const icon=document.getElementById('rec-inp-icon').value.trim()||'ğŸ“…';
  if(!name||!amount||!dueDay||dueDay<1||dueDay>31){toast('âš ï¸ Fill all fields correctly');return;}
  const{db,collection,addDoc,serverTimestamp}=window._fb;
  const COLORS=['#e91e63','#3498db','#2ecc71','#f39c12','#9b59b6','#1abc9c','#e74c3c'];
  const color=COLORS[Math.floor(Math.random()*COLORS.length)];
  syncBadge('saving');
  try{
    await addDoc(collection(db,'recurring'),{name,amount,dueDay,icon,color,createdAt:serverTimestamp()});
    syncBadge('saved');closeModal('rec-modal');toast('âœ… Recurring added');
    document.getElementById('rec-inp-name').value='';
    document.getElementById('rec-inp-amount').value='';
    document.getElementById('rec-inp-day').value='';
    document.getElementById('rec-inp-icon').value='';
  }catch(err){syncBadge('error');toast('âŒ '+err.message);}
}
function deleteRecurring(id){
  confirm2('ğŸ—‘ï¸','Delete Recurring Item?','This entry will be removed permanently.','Delete','#e74c3c',async()=>{
    const{db,doc,deleteDoc}=window._fb;
    syncBadge('saving');
    try{await deleteDoc(doc(db,'recurring',id));syncBadge('saved');toast('ğŸ—‘ï¸ Deleted');}
    catch(err){syncBadge('error');toast('âŒ '+err.message);}
    closeModal('confirm-modal');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLEAR ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function clearAll(){
  confirm2('âš ï¸','Clear All Transactions?','Every transaction will be permanently deleted from Firestore.','Clear All','#e74c3c',async()=>{
    const{db,collection,getDocs,deleteDoc,doc}=window._fb;
    syncBadge('saving');
    try{const s=await getDocs(collection(db,'transactions'));await Promise.all(s.docs.map(d=>deleteDoc(doc(db,'transactions',d.id))));syncBadge('saved');toast('ğŸ—‘ï¸ All cleared');}
    catch(err){syncBadge('error');toast('âŒ '+err.message);}
    closeModal('confirm-modal');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){
  const now=new Date();
  document.getElementById('dash-date').textContent=now.toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long'});
  document.getElementById('hero-month').textContent=now.toLocaleDateString('en-IN',{month:'long',year:'numeric'});
  const exp=monthExp(),inc=monthInc(),te=sum(exp),ti=sum(inc);
  const todayAmt=sum(txns.filter(t=>isToday(t.date)&&t.type==='expense'));
  document.getElementById('hero-balance').textContent=fmt(ti-te);
  document.getElementById('hero-inc').textContent='â‚¹'+fmt(ti);
  document.getElementById('hero-exp').textContent='â‚¹'+fmt(te);
  document.getElementById('hero-today').textContent='â‚¹'+fmt(todayAmt);
  const dim=new Date(now.getFullYear(),now.getMonth()+1,0).getDate(),dLeft=dim-now.getDate();
  const daysElapsed=Math.max(1,now.getDate());
  const burn=te>0?Math.round(te/daysElapsed):0;
  const health=calcH(te,ti,budgets.total);
  const sd=document.getElementById('sur-days');sd.textContent=dLeft;sd.className='sur-num '+(dLeft>15?'ok':dLeft>7?'warn':'crit');
  document.getElementById('sur-burn').textContent='â‚¹'+fmt(burn);
  const sc=document.getElementById('sur-score');sc.textContent=health;sc.className='sur-num '+(health>=70?'ok':health>=40?'warn':'crit');
  // AI
  const pt=document.getElementById('predict-txt');
  if(budgets.total>0){
    const p=(te/budgets.total*100).toFixed(0),rem=Math.max(0,budgets.total-te),proj=burn*dim;
    if(p>90)pt.innerHTML=`ğŸš¨ <strong>${p}%</strong> of budget used! Projected overspend: <strong>â‚¹${fmt(Math.max(0,proj-budgets.total))}</strong>`;
    else if(p>70)pt.innerHTML=`âš ï¸ <strong>${p}%</strong> used. Budget exhausted in ~<strong>${burn>0?Math.floor(rem/burn):'?'} days</strong>`;
    else pt.innerHTML=`âœ¨ On track! Daily avg: <strong>â‚¹${fmt(burn)}</strong> Â· Projected month-end balance: <strong>â‚¹${fmt(ti-proj)}</strong>`;
  }else{pt.innerHTML=`Tap âš™ï¸ to <strong>set a monthly budget</strong> and unlock AI predictions`;}
  // Budget meter
  const p2=budgets.total>0?Math.min((te/budgets.total)*100,100):0;
  const fill=document.getElementById('bud-fill');
  fill.style.width=p2+'%';fill.className='meter-fill '+(p2<60?'mf-low':p2<85?'mf-mid':'mf-high');
  document.getElementById('bud-pct').textContent=p2.toFixed(0)+'%';
  document.getElementById('bud-spent').textContent='â‚¹'+fmt(te)+' spent';
  document.getElementById('bud-left').textContent='â‚¹'+fmt(Math.max(0,budgets.total-te))+' left';
  // Cat chips
  const cs={};exp.forEach(t=>{cs[t.category]=(cs[t.category]||0)+t.amount;});
  document.getElementById('cat-scroll').innerHTML=Object.entries(cs).sort((a,b)=>b[1]-a[1]).map(([id,a])=>{
    const c=getCat(id);return`<div class="cat-chip"><div class="cc-i">${c.icon}</div><div class="cc-n">${c.name}</div><div class="cc-a">â‚¹${fmt(a)}</div></div>`;
  }).join('')||'<div style="color:var(--text3);font-size:13px;padding:8px 4px">No expenses this month</div>';
  renderHeatmap();
  document.getElementById('recent-list').innerHTML=txns.slice(0,8).map(t=>txnH(t)).join('')||
    `<div class="empty"><div class="empty-ico">ğŸ’¸</div><div class="empty-title">No transactions yet</div><div class="empty-sub">Tap ï¼‹ to add your first entry</div></div>`;
}
function calcH(e,i,b){if(i===0)return 50;let s=50+((i-e)/i)*30;if(b>0)s-=((e/b)-.5)*20;if(i>0&&(i-e)/i>=.2)s+=10;if(i>0&&(i-e)/i>=.3)s+=10;return Math.max(0,Math.min(100,Math.round(s)))}
function renderHeatmap(){
  const now=new Date(),g=document.getElementById('hm-grid');
  const cells=[];
  for(let i=34;i>=0;i--){const d=new Date(now);d.setDate(now.getDate()-i);const dk=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');cells.push({dk,amt:sum(txns.filter(t=>t.date.slice(0,10)===dk&&t.type==='expense')),today:i===0});}
  const mx=Math.max(...cells.map(c=>c.amt),1);
  g.innerHTML=cells.map(c=>{const lv=c.amt===0?0:c.amt<mx*.25?1:c.amt<mx*.5?2:c.amt<mx*.75?3:4;return`<div class="hm-cell h${lv}${c.today?' today':''}" title="${c.dk}: â‚¹${fmt(c.amt)}"></div>`;}).join('');
}
function txnH(t){
  const c=getCat(t.category);
  return`<div class="txn-item" onclick="openAddModal(${JSON.stringify(t).replace(/"/g,'&quot;')})">
    <div class="txn-icon" style="background:${c.color}22">${c.icon}</div>
    <div class="txn-info"><div class="txn-title">${t.note}</div><div class="txn-meta"><span>${fmtDate(t.date)}</span><span class="mbadge">${t.method}</span><span>${c.name}</span></div></div>
    <div class="txn-right">
      <div class="txn-amt ${t.type}">${t.type==='expense'?'-':'+'}â‚¹${fmt(t.amount)}</div>
      <div class="txn-del" onclick="event.stopPropagation();deleteTxn('${t.id}')">ğŸ—‘ï¸</div>
    </div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRANSACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setFilter(el,f){curFilter=f;document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active'));el.classList.add('active');renderTxns();}
function renderTxns(){
  const q=(document.getElementById('txn-search')?.value||'').toLowerCase();
  const filtered=txns.filter(t=>{
    const ms=!q||t.note.toLowerCase().includes(q)||t.category.includes(q)||String(t.amount).includes(q);
    const mf=curFilter==='all'?true:(curFilter==='expense'||curFilter==='income')?t.type===curFilter:t.category===curFilter;
    return ms&&mf;
  });
  const groups={};filtered.forEach(t=>{const dk=t.date.slice(0,10);if(!groups[dk])groups[dk]=[];groups[dk].push(t);});
  const cont=document.getElementById('txn-list');
  if(!filtered.length){cont.innerHTML=`<div class="empty"><div class="empty-ico">ğŸ”</div><div class="empty-title">No results</div></div>`;return;}
  cont.innerHTML=Object.entries(groups).sort((a,b)=>b[0].localeCompare(a[0])).map(([date,ts])=>{
    const dayE=sum(ts.filter(t=>t.type==='expense'));
    const d=new Date(date);const lbl=isToday(date+' ')?'Today':d.toLocaleDateString('en-IN',{weekday:'short',day:'numeric',month:'short'});
    return`<div class="txn-group"><div class="txn-group-label">${lbl} Â· â‚¹${fmt(dayE)}</div>${ts.map(t=>txnH(t)).join('')}</div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUDGET SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let donutChart=null;
function renderBudget(){
  const exp=monthExp();const cs={};exp.forEach(t=>{cs[t.category]=(cs[t.category]||0)+t.amount;});
  const entries=Object.entries(cs);
  if(donutChart){donutChart.destroy();donutChart=null;}
  const ctx=document.getElementById('donut-chart');
  if(ctx&&entries.length)donutChart=new Chart(ctx,{type:'doughnut',data:{labels:entries.map(([id])=>getCat(id).name),datasets:[{data:entries.map(([,v])=>v),backgroundColor:entries.map(([id])=>getCat(id).color),borderWidth:0}]},options:{cutout:'70%',plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>` â‚¹${fmt(c.raw)}`}}},animation:{duration:600}}});
  const te=sum(exp);
  document.getElementById('donut-legend').innerHTML=entries.slice(0,5).map(([id,v])=>{const c=getCat(id),p=te>0?((v/te)*100).toFixed(0):0;return`<div class="leg-item"><div class="leg-dot" style="background:${c.color}"></div><div class="leg-lbl">${c.name}</div><div class="leg-val" style="color:${c.color}">${p}%</div></div>`;}).join('');
  document.getElementById('cat-budget-list').innerHTML=CATS.filter(c=>c.id!=='salary').map(c=>{
    const sp=cs[c.id]||0,lim=budgets.cats?.[c.id]||0,p=lim>0?Math.min((sp/lim)*100,100):0;
    if(sp===0&&lim===0)return'';
    return`<div class="cb-item"><div class="cb-top"><div class="cb-icon" style="background:${c.color}22">${c.icon}</div><div class="cb-name">${c.name}</div><div class="cb-amounts"><div class="cb-spent" style="color:${c.color}">â‚¹${fmt(sp)}</div><div class="cb-of">${lim>0?'of â‚¹'+fmt(lim):'no limit'}</div></div></div>${lim>0?`<div class="meter-track"><div class="meter-fill ${p<60?'mf-low':p<85?'mf-mid':'mf-high'}" style="width:${p}%"></div></div><div style="display:flex;justify-content:space-between;margin-top:4px"><span style="font-size:10px;color:var(--text3)">${p.toFixed(0)}% used</span>${sp>lim?`<span style="font-size:10px;color:var(--red);font-weight:600">âš ï¸ Over budget</span>`:`<span style="font-size:10px;color:var(--text3)">â‚¹${fmt(lim-sp)} left</span>`}</div>`:''}`;
  }).filter(Boolean).join('');
  document.getElementById('goals-list').innerHTML=goals.map(g=>{const p=Math.min((g.saved/g.target)*100,100),d=Math.ceil((g.target-g.saved)/30);return`<div class="goal-card"><div class="goal-top"><div class="goal-ico">${g.icon}</div><div style="flex:1"><div class="goal-name">${g.name}</div><div class="goal-target">Target: â‚¹${fmt(g.target)}</div></div><div class="txn-del" onclick="deleteGoal('${g.id}')">ğŸ—‘ï¸</div></div><div class="goal-pr"><span class="goal-saved">â‚¹${fmt(g.saved)} saved</span><span class="goal-eta">â‚¹${fmt(d)}/day needed</span></div><div class="meter-track"><div class="meter-fill" style="width:${p}%;background:var(--green)"></div></div><div style="text-align:right;font-size:10px;color:var(--text3);margin-top:4px">${p.toFixed(0)}% complete</div></div>`;}).join('')||`<div style="padding:0 16px 8px;color:var(--text3);font-size:13px">No goals yet. Tap ï¼‹ Add above.</div>`;
  const today=new Date();
  document.getElementById('rec-list').innerHTML=recurring.length?recurring.map(r=>{const due=new Date(today.getFullYear(),today.getMonth(),r.dueDay);if(due<today)due.setMonth(due.getMonth()+1);const du=Math.ceil((due-today)/864e5);return`<div class="rec-item"><div class="rec-icon" style="background:${r.color}22">${r.icon}</div><div class="rec-info"><div class="rec-name">${r.name} <span class="due-b ${du<=5?'soon':'ok'}">Due in ${du}d</span></div><div class="rec-due">Every month on ${r.dueDay}th</div></div><div class="rec-amt">â‚¹${fmt(r.amount)}</div><div class="txn-del" onclick="deleteRecurring('${r.id}')">ğŸ—‘ï¸</div></div>`;}).join(''):`<div style="padding:0 16px 8px;color:var(--text3);font-size:13px">No recurring items. Tap ï¼‹ Add above.</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANALYTICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAnalytics(){
  Object.values(charts).forEach(c=>{try{c.destroy()}catch(e){}});charts={};
  const exp=monthExp(),inc=monthInc(),te=sum(exp),ti=sum(inc);
  const sr=ti>0?(((ti-te)/ti)*100).toFixed(0):0;
  const now=new Date(),daysElapsed2=Math.max(1,now.getDate()),burn=te>0?Math.round(te/daysElapsed2):0;
  document.getElementById('stats-grid').innerHTML=[{l:'Month Expenses',v:'â‚¹'+fmt(te),c:'var(--red)'},{l:'Month Income',v:'â‚¹'+fmt(ti),c:'var(--green)'},{l:'Savings Rate',v:sr+'%',c:sr>=20?'var(--green)':'var(--gold)'},{l:'Daily Burn',v:'â‚¹'+fmt(burn),c:'var(--gold)'}].map(s=>`<div class="stat-mini"><div class="stat-mini-lbl">${s.l}</div><div class="stat-mini-val" style="color:${s.c}">${s.v}</div></div>`).join('');
  document.getElementById('daily-sub').textContent=`â‚¹${fmt(te)} total Â· ${exp.length} transactions`;
  const dl=[],dd=[];
  for(let i=29;i>=0;i--){const d=new Date(now);d.setDate(now.getDate()-i);const dk=d.toISOString().slice(0,10);dl.push(i===0?'Today':d.getDate()+'/'+(d.getMonth()+1));dd.push(sum(txns.filter(t=>t.date.slice(0,10)===dk&&t.type==='expense')));}
  const cs2={font:{family:'DM Mono',size:10},color:'#9090b0'},gc='rgba(255,255,255,.05)';
  charts.daily=new Chart(document.getElementById('chart-daily'),{type:'bar',data:{labels:dl,datasets:[{data:dd,backgroundColor:dd.map((_,i)=>i===29?'#f5a623':'rgba(245,166,35,.3)'),borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>` â‚¹${fmt(c.raw)}`}}},scales:{x:{ticks:{...cs2,maxRotation:0,maxTicksLimit:8},grid:{color:gc}},y:{ticks:{...cs2,callback:v=>'â‚¹'+fmt(v)},grid:{color:gc}}}}});
  const cSp={};exp.forEach(t=>{cSp[t.category]=(cSp[t.category]||0)+t.amount;});const ce=Object.entries(cSp).sort((a,b)=>b[1]-a[1]);
  charts.cat=new Chart(document.getElementById('chart-cat'),{type:'doughnut',data:{labels:ce.map(([id])=>getCat(id).name),datasets:[{data:ce.map(([,v])=>v),backgroundColor:ce.map(([id])=>getCat(id).color),borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,cutout:'60%',plugins:{legend:{display:true,position:'right',labels:{color:'#9090b0',font:{size:10,family:'Sora'},padding:8,boxWidth:10}},tooltip:{callbacks:{label:c=>` ${c.label}: â‚¹${fmt(c.raw)}`}}}}});
  const m6=[],i6=[],e6=[];
  for(let i=5;i>=0;i--){const d=new Date(now.getFullYear(),now.getMonth()-i,1);m6.push(d.toLocaleDateString('en-IN',{month:'short'}));const mt=txns.filter(t=>{const td=new Date(t.date);return td.getFullYear()===d.getFullYear()&&td.getMonth()===d.getMonth();});i6.push(sum(mt.filter(t=>t.type==='income')));e6.push(sum(mt.filter(t=>t.type==='expense')));}
  charts.compare=new Chart(document.getElementById('chart-compare'),{type:'bar',data:{labels:m6,datasets:[{label:'Income',data:i6,backgroundColor:'rgba(46,204,113,.7)',borderRadius:6},{label:'Expense',data:e6,backgroundColor:'rgba(231,76,60,.7)',borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#9090b0',font:{size:11},padding:10}},tooltip:{callbacks:{label:c=>` â‚¹${fmt(c.raw)}`}}},scales:{x:{ticks:cs2,grid:{color:gc}},y:{ticks:{...cs2,callback:v=>'â‚¹'+fmt(v)},grid:{color:gc}}}}});
  const ins=[];
  if(!ce.length)ins.push({icon:'ğŸ’¡',title:'No data yet',desc:'Add transactions to see smart insights.'});
  else{
    ins.push({icon:'ğŸ”¥',title:`Top: ${getCat(ce[0][0]).name}`,desc:`â‚¹${fmt(ce[0][1])} â€” ${te>0?((ce[0][1]/te)*100).toFixed(0):0}% of total spending this month.`});
    if((cSp['food']||0)>5000)ins.push({icon:'ğŸ•',title:'Food spending high',desc:`â‚¹${fmt(cSp['food'])} on food. Could save ~â‚¹${fmt(Math.round((cSp['food']||0)*.3))}/month by cooking more.`});
    if(sr>=20)ins.push({icon:'ğŸŒŸ',title:`Saving ${sr}% â€” Great!`,desc:'Above the recommended 20% threshold!'});
    else if(ti>0)ins.push({icon:'âš ï¸',title:`Savings rate: ${sr}%`,desc:`Aim for 20%. Cut â‚¹${fmt(Math.round(ti*.2-(ti-te)))} more this month.`});
    const dL=new Date(now.getFullYear(),now.getMonth()+1,0).getDate()-now.getDate();
    if(burn>0&&dL>0)ins.push({icon:'ğŸ“Š',title:'Burn Rate Forecast',desc:`â‚¹${fmt(burn)}/day â†’ â‚¹${fmt(burn*dL)} more to spend. Month-end total: ~â‚¹${fmt(te+burn*dL)}.`});
  }
  document.getElementById('insights-list').innerHTML=ins.map(i=>`<div class="insight-card"><div class="insight-icon">${i.icon}</div><div><div class="insight-title">${i.title}</div><div class="insight-desc">${i.desc}</div></div></div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV(){const rows=[['Date','Type','Category','Note','Amount','Method'],...txns.map(t=>[fmtDate(t.date),t.type,getCat(t.category).name,t.note,t.amount,t.method])];const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([rows.map(r=>r.map(v=>`"${v}"`).join(',')).join('\n')],{type:'text/csv'}));a.download='paisa_transactions.csv';a.click();toast('ğŸ“ CSV exported');}
function exportExcel(){try{const d=[['Date','Type','Category','Note','Amount','Method'],...txns.map(t=>[fmtDate(t.date),t.type,getCat(t.category).name,t.note,t.amount,t.method])];const wb=XLSX.utils.book_new(),ws=XLSX.utils.aoa_to_sheet(d);ws['!cols']=[{wch:16},{wch:10},{wch:14},{wch:30},{wch:12},{wch:12}];XLSX.utils.book_append_sheet(wb,ws,'Transactions');XLSX.writeFile(wb,'paisa_transactions.xlsx');toast('ğŸ“Š Excel exported');}catch(e){toast('âŒ Export failed');}}
</script>
</body>
</html>
